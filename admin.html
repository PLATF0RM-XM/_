<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>منصة XM – مستثمر / أدمن</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{margin:0;font-family:Tahoma;background:#0b1a33;color:#fff}
header{padding:15px;text-align:center;background:linear-gradient(135deg,#0c2c57,#07162e)}
.container{max-width:1100px;margin:20px auto;padding:20px}
.card{background:rgba(255,255,255,.08);border-radius:16px;padding:20px;margin-bottom:20px}
input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:none}
button{background:#00c176;font-weight:bold}
.hidden{display:none}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #2a3f6e;text-align:center}
img{max-width:120px;border-radius:8px}
a{color:#00c176}
</style>
</head>

<body>
<header>منصة XM الاستثمارية</header>
<div class="container">

<!-- Investor -->
<div id="investor" class="card">
<h3>تابع صفقتك</h3>
<input id="dealSearch" placeholder="رقم الصفقة">
<button onclick="searchDeal()">عرض البيانات</button>
<div id="dealData"></div>
</div>

<!-- Payment -->
<div id="payment" class="card hidden">
<h3>سداد الرسوم</h3>
<p>رقم فودافون كاش: <b>01000000000</b></p>
<input type="file" id="payImg" accept="image/*">
<button onclick="uploadPayment()">رفع صورة التحويل</button>
<div id="payMsg"></div>
</div>

<!-- Admin Login -->
<div id="adminLogin" class="card hidden">
<h3>دخول الأدمن</h3>
<input id="adminEmail" placeholder="البريد الإلكتروني">
<input id="adminPass" type="password">
<button onclick="adminLogin()">دخول</button>
<div id="adminError"></div>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="card hidden">
<h3>لوحة الإدارة</h3>
<input id="dealId" placeholder="رقم الصفقة">
<input id="name" placeholder="اسم المستثمر">
<input id="amount" type="number" placeholder="مبلغ الاستثمار">
<input id="profit" type="number" placeholder="الربح">
<input id="fees" type="number" placeholder="الرسوم">
<select id="status">
<option value="pending">معلقة</option>
<option value="paid">تم السداد</option>
<option value="completed">مكتملة</option>
</select>
<button onclick="saveDeal()">حفظ الصفقة</button>

<hr>
<table>
<thead>
<tr><th>رقم</th><th>اسم</th><th>مبلغ</th><th>رسوم</th><th>حالة</th><th>صورة</th></tr>
</thead>
<tbody id="dealsTable"></tbody>
</table>
</div>

</div>

<script>
const firebaseConfig = {
 apiKey: "AIzaSyDCVCtl1ca3NSoy6tAWCp-ykgGBa21ZNp8",
 authDomain: "investment-platform-b419d.firebaseapp.com",
 projectId: "investment-platform-b419d",
 storageBucket: "investment-platform-b419d.firebasestorage.app",
 appId: "1:831226258536:web:6aae445cb9d33d06cd07dd"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore(), storage=firebase.storage();

if(location.hash==="#admin"){
 investor.classList.add("hidden");
 adminLogin.classList.remove("hidden");
}

let currentDeal="";

function adminLogin(){
 auth.signInWithEmailAndPassword(adminEmail.value,adminPass.value)
 .then(()=>{adminLogin.classList.add("hidden");adminPanel.classList.remove("hidden");loadDeals();})
 .catch(()=>adminError.innerText="خطأ في الدخول");
}

function saveDeal(){
 db.collection("deals").doc(dealId.value).set({
  investor:name.value,
  amount:+amount.value,
  profit:+profit.value,
  fees:+fees.value,
  status:status.value
 });
}

function loadDeals(){
 db.collection("deals").onSnapshot(s=>{
  dealsTable.innerHTML="";
  s.forEach(d=>{
   let x=d.data();
   dealsTable.innerHTML+=`<tr>
   <td>${d.id}</td>
   <td>${x.investor}</td>
   <td>${x.amount}</td>
   <td>${x.fees}</td>
   <td>${x.status}</td>
   <td>${x.paymentImage?`<a href="${x.paymentImage}" target="_blank">عرض</a>`:"-"}</td>
   </tr>`;
  });
 });
}

function searchDeal(){
 currentDeal=dealSearch.value;
 db.collection("deals").doc(currentDeal).get().then(d=>{
  if(!d.exists){dealData.innerHTML="لا توجد صفقة";return;}
  let x=d.data();
  dealData.innerHTML=`
   <p>الاسم: ${x.investor}</p>
   <p>المبلغ: ${x.amount}</p>
   <p>الربح: ${x.profit}</p>
   <p>الرسوم: ${x.fees}</p>
   <p>الحالة: ${x.status}</p>
   ${x.fees>0?'<button onclick="openPayment()">سدد الآن</button>':''}
  `;
 });
}

function openPayment(){
 payment.classList.remove("hidden");
}

function uploadPayment(){
 const file=payImg.files[0];
 if(!file)return;
 const ref=storage.ref("payments/"+currentDeal);
 ref.put(file).then(()=>ref.getDownloadURL())
 .then(url=>{
  return db.collection("deals").doc(currentDeal).update({
   paymentImage:url,
   status:"paid"
  });
 }).then(()=>payMsg.innerText="تم رفع الصورة بنجاح");
}
</script>
</body>
</html>
